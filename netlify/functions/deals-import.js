const h={"Content-Type":"application/json; charset=utf-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization"};const T=(process.env.PIPEDRIVE_API_TOKEN||"").trim();const HOSTS=["https://api.pipedrive.com/v1","https://api-eu.pipedrive.com/v1"];const R=(c,d)=>({statusCode:c,headers:h,body:JSON.stringify(d)});async function call(path){const a=[];for(const host of HOSTS){const sep=path.includes("?")?"&":"?";const raw=`${host}${path}${sep}api_token=${encodeURIComponent(T)}`;try{const res=await fetch(raw,{headers:{Accept:"application/json"},redirect:"follow"});const txt=await res.text().catch(()=>""),ct=res.headers.get("content-type"),msk=raw.replace(/(api_token=)[^&]+/i,"$1***"),sn=(txt||"").replace(/\s+/g," ").trim().slice(0,800);a.push({host,status:res.status,statusText:res.statusText,url:msk,contentType:ct,bodySnippet:sn});if(res.ok&&ct&&ct.toLowerCase().includes("application/json")){try{return{ok:true,hostUsed:host,json:JSON.parse(txt),attempts:a}}catch{}}}catch(e){a.push({host,status:0,statusText:String(e&&e.message?e.message:e),url:raw.replace(/(api_token=)[^&]+/i,"$1***"),contentType:null,bodySnippet:""})}}return{ok:false,attempts:a}}exports.handler=async(e)=>{if(e.httpMethod==="OPTIONS")return R(204,"");try{if(e.httpMethod!=="POST")return R(405,{error:"Method Not Allowed"});if(!e.body)return R(400,{error:"Body vacío"});let p;try{p=JSON.parse(e.body)}catch{return R(400,{error:"JSON inválido"})}const id=String(p&&p.federalNumber||"").trim();if(!id)return R(400,{error:"federalNumber requerido"});if(!T)return R(400,{error:"PIPEDRIVE_API_TOKEN no definido"});const det=await call(`/deals/${encodeURIComponent(id)}`);if(!det.ok)return R(502,{error:"pipedrive_upstream_failed",attempts:det.attempts});return R(200,{ok:true,host_used:det.hostUsed,pipedrive:det.json})}catch(e){return R(500,{error:String(e&&e.message?e.message:e)})}};
